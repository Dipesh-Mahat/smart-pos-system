<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart POS - AI Business Insights</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/menu.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Include Auth Service for token management -->
    <script src="../js/auth-service.js"></script>
    <script src="../js/api-service.js"></script>
    <script src="../js/menu.js"></script>
    <script src="../js/navbar.js"></script>

    <style>
        .main-content {
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
            margin-left: 250px;
            padding-top: 80px;
        }

        /* Offline badge removed */

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 80px 15px 15px 15px;
            }
        }

        .ai-container {
            max-width: 100%;
            margin: 0;
            padding: 0 10px;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: auto;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .refresh-btn:hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .refresh-btn:active {
            transform: rotate(180deg) scale(0.95);
        }

        .header-subtitle {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .business-context {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .business-info .business-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-right: 12px;
        }

        .business-info .business-type {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .data-quality {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .data-quality.excellent { color: #4CAF50; }
        .data-quality.good { color: #FFC107; }
        .data-quality.fair { color: #FF9800; }
        .data-quality.poor { color: #F44336; }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .insight-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .card-icon.sales { background: linear-gradient(135deg, #28a745, #20c997); }
        .card-icon.inventory { background: linear-gradient(135deg, #007bff, #6610f2); }
        .card-icon.customers { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .card-icon.finance { background: linear-gradient(135deg, #17a2b8, #6f42c1); }
        .card-icon.products { background: linear-gradient(135deg, #e83e8c, #fd7e14); }
        .card-icon.clearance { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .card-icon.business { background: linear-gradient(135deg, #6f42c1, #e83e8c); }

        .extra-info {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .extra-info i {
            font-size: 0.8rem;
        }

        .confidence-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .confidence-indicator i {
            color: #ffc107;
        }

        /* Enhanced card hover effects */
        .insight-card:hover .extra-info {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        /* Simple Loading Animation Styles */
        .simple-loading-card {
            background: white;
            border-radius: 16px;
            padding: 40px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 200px;
        }

        .loading-pulse {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            animation: simple-pulse 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
        }

        @keyframes simple-pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.7;
            }
            50% { 
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .confidence-badge {
            display: none; /* Hiding confidence badges */
        }

        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .insights-list li i {
            color: #28a745;
            margin-top: 2px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 80px 10px 15px 10px;
            }
            
            .ai-container {
                padding: 0 5px;
            }
            
            .header-title {
                font-size: 1.6rem;
                text-align: center;
            }
            
            .header-subtitle {
                font-size: 1rem;
                text-align: center;
                margin-bottom: 20px;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .insight-card {
                padding: 16px;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .card-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .confidence-badge {
                padding: 3px 8px;
                font-size: 0.7rem;
                top: 12px;
                right: 12px;
            }
            
            .insights-list li {
                padding: 10px 0;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 8px 10px 8px;
            }
            
            .header-title {
                font-size: 1.4rem;
            }
            
            .header-subtitle {
                font-size: 0.95rem;
            }
            
            .insight-card {
                padding: 14px;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .insights-list li {
                font-size: 0.85rem;
                padding: 8px 0;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="ai-container">
            <div class="header-section">
                <h1 class="header-title">
                    <i class="fas fa-brain"></i>
                    <span id="personalizedTitle">Smart POS Assistant</span>
                    <button onclick="window.location.reload()" class="refresh-btn" title="Refresh for new insights">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </h1>
                <p class="header-subtitle">AI-powered insights to boost your business performance</p>
                <div class="business-context" id="businessContext" style="display: none;">
                    <div class="business-info">
                        <span class="business-name" id="businessName"></span>
                        <span class="business-type" id="businessType"></span>
                    </div>
                    <div class="data-quality" id="dataQuality"></div>
                </div>
            </div>

            <div id="insightsSection" class="insights-grid">
                <!-- AI Insights will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // AI Dashboard for Smart POS System
        let aiData = null;
        let isLoading = false;

        // Real data engine using backend API
        const realDataEngine = {
            // Fetch real business data from backend
            fetchBusinessData: async function() {
                try {
                    const response = await fetch('/api/shop/products', {
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.products || data; // Handle different response formats
                    }
                } catch (error) {
                    console.error('Error fetching business data:', error);
                }
                return null;
            },

            // Fetch real transaction data
            fetchTransactionData: async function() {
                try {
                    const response = await fetch('/api/transactions', {
                        headers: {
                            'Authorization': `Bearer ${getAuthToken()}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.transactions || data; // Handle different response formats
                    }
                } catch (error) {
                    console.error('Error fetching transaction data:', error);
                }
                return null;
            },

            // Generate restock recommendations from real data
            generateRealRestockRecommendations: function(products) {
                if (!products || !products.length) return this.getFallbackRestock();
                
                const lowStockProducts = products.filter(product => 
                    product.stock <= product.minStockLevel && product.stock > 0
                );
                
                const outOfStockProducts = products.filter(product => 
                    product.stock === 0
                );

                const recommendations = [];
                
                // Critical out of stock items
                outOfStockProducts.slice(0, 2).forEach(product => {
                    recommendations.push(`${product.name} - CRITICAL: Out of stock! Immediate reorder required.`);
                });
                
                // Low stock items
                lowStockProducts.slice(0, 3).forEach(product => {
                    const daysLeft = Math.ceil(product.stock / 2); // Assuming 2 sales per day
                    recommendations.push(`${product.name} - Only ${product.stock} units left (${daysLeft} days). Restock needed.`);
                });

                return recommendations.length > 0 ? recommendations : this.getFallbackRestock();
            },

            // Generate clearance suggestions from real data
            generateRealClearanceRecommendations: function(products) {
                if (!products || !products.length) return this.getFallbackClearance();
                
                const slowMovingProducts = products.filter(product => 
                    product.stock > product.minStockLevel * 3 && product.stock > 10
                );
                
                const recommendations = [];
                
                slowMovingProducts.slice(0, 3).forEach(product => {
                    const overstock = product.stock - product.minStockLevel;
                    const discountSuggestion = overstock > 50 ? '40%' : overstock > 20 ? '25%' : '15%';
                    recommendations.push(`${product.name} - Overstocked with ${product.stock} units. Consider ${discountSuggestion} discount.`);
                });

                return recommendations.length > 0 ? recommendations : this.getFallbackClearance();
            },

            // Generate sales insights from real data
            generateRealSalesInsights: function(products, transactions) {
                const insights = [];
                
                if (products && products.length > 0) {
                    // Find high-margin products
                    const highMarginProducts = products.filter(p => 
                        p.costPrice && (p.price - p.costPrice) / p.costPrice > 0.5
                    ).slice(0, 2);
                    
                    if (highMarginProducts.length > 0) {
                        insights.push(`High-profit items: ${highMarginProducts.map(p => p.name).join(', ')} have great margins. Promote these more.`);
                    }
                    
                    // Find popular categories
                    const categories = {};
                    products.forEach(p => {
                        categories[p.category] = (categories[p.category] || 0) + 1;
                    });
                    
                    const topCategory = Object.keys(categories).reduce((a, b) => 
                        categories[a] > categories[b] ? a : b
                    );
                    
                    insights.push(`${topCategory} category has the most products (${categories[topCategory]} items). Focus marketing here.`);
                }
                
                if (transactions && transactions.length > 0) {
                    const avgTransaction = transactions.reduce((sum, t) => sum + t.total, 0) / transactions.length;
                    insights.push(`Average transaction: Rs. ${avgTransaction.toFixed(0)}. Bundle items to increase basket size.`);
                }
                
                return insights.length > 0 ? insights : this.getFallbackSales();
            },

            // Fallback recommendations
            getFallbackRestock: function() {
                return [
                    "Monitor your best-selling items daily to prevent stockouts",
                    "Set up automatic reorder points for essential products",
                    "Review supplier lead times to optimize ordering schedule"
                ];
            },

            getFallbackClearance: function() {
                return [
                    "Review products with no sales in the last 30 days",
                    "Consider seasonal clearance for weather-dependent items",
                    "Bundle slow-moving items with popular products"
                ];
            },

            getFallbackSales: function() {
                return [
                    "Cross-sell complementary products at checkout",
                    "Focus on high-margin items during peak hours",
                    "Implement loyalty program for repeat customers"
                ];
            },

            getFallbackCustomer: function() {
                return [
                    "Track customer purchase patterns for better service",
                    "Group related products together for convenience",
                    "Offer personalized recommendations based on history"
                ];
            }
        };

        // Two types of AI helper content that rotate on reload (without emojis)
        const aiHelperContent = {
            type1: {
                title: 'Smart POS Assistant',
                subtitle: 'Data-driven insights to optimize your business performance',
                insights: {
                    restock: {
                        title: 'Restock Alerts',
                        icon: 'inventory',
                        iconClass: 'fas fa-exclamation-triangle',
                        color: '#dc3545'
                    },
                    clearance: {
                        title: 'Clearance Suggestions',
                        icon: 'clearance',
                        iconClass: 'fas fa-percentage',
                        color: '#28a745'
                    },
                    sales: {
                        title: 'Sales Optimization',
                        icon: 'sales',
                        iconClass: 'fas fa-chart-line',
                        color: '#007bff'
                    },
                    customers: {
                        title: 'Customer Insights',
                        icon: 'customers',
                        iconClass: 'fas fa-users',
                        color: '#ffc107'
                    }
                }
            },
            type2: {
                title: 'Business Intelligence Hub',
                subtitle: 'Real-time analytics and smart inventory management',
                insights: {
                    restock: {
                        title: 'Inventory Alerts',
                        icon: 'inventory',
                        iconClass: 'fas fa-boxes',
                        color: '#e74c3c'
                    },
                    clearance: {
                        title: 'Stock Clearance',
                        icon: 'clearance',
                        iconClass: 'fas fa-tag',
                        color: '#2ecc71'
                    },
                    sales: {
                        title: 'Revenue Analytics',
                        icon: 'sales',
                        iconClass: 'fas fa-rocket',
                        color: '#3498db'
                    },
                    customers: {
                        title: 'Purchase Patterns',
                        icon: 'customers',
                        iconClass: 'fas fa-brain',
                        color: '#9b59b6'
                    }
                }
            }
        };

        // Smart fallback insights (kept as backup)
        const fallbackInsights = {
            sales: {
                title: 'Sales Optimization',
                icon: 'sales',
                iconClass: 'fas fa-chart-line',
                confidence: 'high',
                insights: [
                    "Most of your sales happen between 2-5 PM. Try special offers in the morning or evening to bring in more customers.",
                    "Sales go up by 40% on weekends. Make sure you have enough stock before Saturday and Sunday.",
                    "Suggest related products at checkout to help customers and increase each bill.",
                    "Reward your regular customers with discounts or points to keep them coming back."
                ]
            },
            inventory: {
                title: 'Inventory Tips',
                icon: 'inventory',
                iconClass: 'fas fa-boxes',
                confidence: 'high',
                insights: [
                    "Check your best-selling items every week so you don't run out.",
                    "If something hasn't sold in a month, try a small discount to clear space.",
                    "Before festivals, order extra of your popular products about 2 weeks early.",
                    "A few products bring in most of your sales—focus on keeping those always available."
                ]
            },
            finance: {
                title: 'Financial Health',
                icon: 'finance',
                iconClass: 'fas fa-piggy-bank',
                confidence: 'medium',
                insights: [
                    "Keep enough stock for 3 months to avoid sudden shortages.",
                    "Write down your daily expenses to spot where you can save money.",
                    "You earn the most profit on items you buy locally—try to stock more of these.",
                    "Encourage digital payments—they can help you save on transaction fees."
                ]
            }
        };

        // Initialize the AI dashboard with real data
        async function initializeAIDashboard() {
            console.log('Smart POS AI Dashboard initializing with real data...');
            
            // Update page title and subtitle based on helper type
            updateAIHelperInterface();
            
            try {
                // Load real data recommendations
                await loadRealDataRecommendations();
                
                // Then try to enhance with AI insights if available
                // await loadAIInsights();
            } catch (error) {
                console.error('Real data service unavailable, using fallback:', error);
                loadFallbackInsights('fallback');
            }
        }

        // Update AI helper interface with rotating content types
        function updateAIHelperInterface() {
            // Determine which type to show (alternates on each reload)
            const showType2 = Math.random() > 0.5; // 50% chance for each type
            const currentType = showType2 ? aiHelperContent.type2 : aiHelperContent.type1;
            
            // Store current type for use in recommendations
            window.currentAIHelperType = currentType;
            
            // Update title and subtitle
            const titleElement = document.getElementById('personalizedTitle');
            const subtitleElement = document.querySelector('.header-subtitle');
            
            if (titleElement) {
                titleElement.innerHTML = `<i class="fas fa-brain"></i> ${currentType.title}`;
            }
            
            if (subtitleElement) {
                subtitleElement.textContent = currentType.subtitle;
            }
            
            console.log(`AI Helper Type: ${showType2 ? 'Type 2' : 'Type 1'} loaded`);
        }

        // Load real data recommendations
        async function loadRealDataRecommendations() {
            console.log('Loading real business data recommendations...');
            
            // Show simple loading animation
            showSimpleLoading();
            
            try {
                // Fetch real data from backend
                const [productsData, transactionsData] = await Promise.all([
                    realDataEngine.fetchBusinessData(),
                    realDataEngine.fetchTransactionData()
                ]);
                
                console.log('Products loaded:', productsData?.length || 0);
                console.log('Transactions loaded:', transactionsData?.length || 0);
                
                // Get current AI helper type
                const helperType = window.currentAIHelperType || aiHelperContent.type1;
                
                // Generate real data-based recommendations
                const recommendations = {
                    restock: realDataEngine.generateRealRestockRecommendations(productsData),
                    clearance: realDataEngine.generateRealClearanceRecommendations(productsData),
                    sales: realDataEngine.generateRealSalesInsights(productsData, transactionsData),
                    customers: realDataEngine.getFallbackCustomer()
                };
                
                // Create insight cards with real data
                const insightCards = [
                    {
                        title: helperType.insights.restock.title,
                        icon: helperType.insights.restock.icon,
                        iconClass: helperType.insights.restock.iconClass,
                        confidence: 'high',
                        insights: recommendations.restock,
                        extraInfo: `${recommendations.restock.length} items need attention`,
                        customColor: helperType.insights.restock.color
                    },
                    {
                        title: helperType.insights.clearance.title,
                        icon: helperType.insights.clearance.icon,
                        iconClass: helperType.insights.clearance.iconClass,
                        confidence: 'high',
                        insights: recommendations.clearance,
                        extraInfo: `${recommendations.clearance.length} opportunities found`,
                        customColor: helperType.insights.clearance.color
                    },
                    {
                        title: helperType.insights.sales.title,
                        icon: helperType.insights.sales.icon,
                        iconClass: helperType.insights.sales.iconClass,
                        confidence: 'medium',
                        insights: recommendations.sales,
                        extraInfo: 'Based on current inventory',
                        customColor: helperType.insights.sales.color
                    },
                    {
                        title: helperType.insights.customers.title,
                        icon: helperType.insights.customers.icon,
                        iconClass: helperType.insights.customers.iconClass,
                        confidence: 'medium',
                        insights: recommendations.customers,
                        extraInfo: 'Customer behavior analysis',
                        customColor: helperType.insights.customers.color
                    }
                ];
                
                // Small delay for smooth transition
                setTimeout(() => {
                    displayInsights(insightCards);
                    console.log('Real data recommendations loaded successfully');
                }, 600);
                
            } catch (error) {
                console.error('Error loading real data:', error);
                // Fall back to rule-based recommendations
                setTimeout(() => {
                    loadFallbackInsights('fallback');
                }, 400);
            }
        }

        // Attempt to load AI insights from backend with personalized data
        async function loadAIInsights() {
            console.log('Loading AI insights with skeleton animation...');
            
            // Show skeleton loading first
            showSkeletonLoading();
            
            try {
                // Check if we're running on a development HTTP server
                const isLocalHttpServer = window.location.hostname === '127.0.0.1' && 
                    (window.location.port === '5500' || window.location.port === '8080');
                    
            // If we're on the HTTP server without backend, use offline mode
            if (isLocalHttpServer) {
                console.log('Smart offline mode detected - using pre-generated insights');
                // Small delay to show skeleton before loading fallback
                setTimeout(() => {
                    loadFallbackInsights('offline');
                }, 800);
                return;
            }                const response = await fetch('/api/ai-intelligence/dashboard', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Personalized AI data received:', data);
                    
                    if (data.success && data.data) {
                        // Display personalized business context
                        displayBusinessContext(data.data);
                        
                        // Display AI insights
                        if (data.data.aiInsights && data.data.aiInsights.insights) {
                            aiData = data.data;
                            displayPersonalizedAIInsights();
                            return;
                        } else if (data.data.aiInsights) {
                            // Handle fallback recommendations
                            displayPersonalizedFallbackInsights(data.data.aiInsights);
                            return;
                        }
                    }
                }
                
                throw new Error('AI service currently unavailable');
                
            } catch (error) {
                console.log('Switching to offline mode with smart insights:', error);
                // Small delay to show skeleton before loading fallback
                setTimeout(() => {
                    loadFallbackInsights('offline');
                }, 500);
            }
        }

        // Display personalized business context
        function displayBusinessContext(data) {
            const businessContext = document.getElementById('businessContext');
            const businessName = document.getElementById('businessName');
            const businessType = document.getElementById('businessType');
            const dataQuality = document.getElementById('dataQuality');
            const personalizedTitle = document.getElementById('personalizedTitle');

            if (data.businessProfile) {
                const profile = data.businessProfile;
                
            // Update title with business name
            if (personalizedTitle && profile.business.name) {
                personalizedTitle.textContent = `AI Insights for ${profile.business.name}`;
            }                // Display business info
                if (businessName) {
                    businessName.textContent = profile.business.name || 'Your Business';
                }
                
                if (businessType) {
                    businessType.textContent = profile.business.type || 'Retail';
                }

                // Display data quality
                if (dataQuality && data.dataQuality) {
                    const quality = data.dataQuality;
                    dataQuality.innerHTML = `
                        <i class="fas fa-chart-bar"></i>
                        <span>Data Quality: ${quality.level.charAt(0).toUpperCase() + quality.level.slice(1)} (${Math.round(quality.score * 100)}%)</span>
                    `;
                    dataQuality.className = `data-quality ${quality.level}`;
                }

                // Show business context
                if (businessContext) {
                    businessContext.style.display = 'flex';
                }
            }
        }

        // Display personalized AI insights
        function displayPersonalizedAIInsights() {
            if (!aiData || !aiData.aiInsights || !aiData.aiInsights.insights) {
                loadFallbackInsights('fallback');
                return;
            }

            const insights = aiData.aiInsights.insights;
            const insightCards = [];

            // Convert personalized AI data to display format
            if (insights.salesPrediction) {
                insightCards.push({
                    title: 'Sales Intelligence',
                    icon: 'sales',
                    iconClass: 'fas fa-chart-line',
                    confidence: insights.salesPrediction.confidenceLevel || 'medium',
                    insights: insights.salesPrediction.insights || [],
                    extraInfo: insights.salesPrediction.nextMonthRevenue 
                        ? `Projected Revenue: ${aiData.businessProfile?.business?.currency || 'NPR'} ${insights.salesPrediction.nextMonthRevenue.toFixed(0)}`
                        : null
                });
            }

            if (insights.inventoryOptimization) {
                insightCards.push({
                    title: 'Inventory Optimization',
                    icon: 'inventory',
                    iconClass: 'fas fa-boxes',
                    confidence: insights.inventoryOptimization.confidence || 'medium',
                    insights: insights.inventoryOptimization.insights || [],
                    extraInfo: insights.inventoryOptimization.costSavings
                        ? `Potential Savings: ${aiData.businessProfile?.business?.currency || 'NPR'} ${insights.inventoryOptimization.costSavings.toFixed(0)}`
                        : null
                });
            }

            if (insights.customerBehavior) {
                insightCards.push({
                    title: 'Customer Analytics',
                    icon: 'customers',
                    iconClass: 'fas fa-users',
                    confidence: insights.customerBehavior.confidence || 'medium',
                    insights: insights.customerBehavior.insights || []
                });
            }

            if (insights.pricingStrategy) {
                insightCards.push({
                    title: 'Pricing Strategy',
                    icon: 'finance',
                    iconClass: 'fas fa-tag',
                    confidence: insights.pricingStrategy.confidence || 'medium',
                    insights: insights.pricingStrategy.insights || [],
                    extraInfo: insights.pricingStrategy.revenueImpact?.projectedIncrease
                        ? `Revenue Impact: +${aiData.businessProfile?.business?.currency || 'NPR'} ${insights.pricingStrategy.revenueImpact.projectedIncrease.toFixed(0)}`
                        : null
                });
            }

            if (insights.productPerformance) {
                insightCards.push({
                    title: 'Product Performance',
                    icon: 'products',
                    iconClass: 'fas fa-shopping-bag',
                    confidence: insights.productPerformance.confidence || 'medium',
                    insights: insights.productPerformance.insights || []
                });
            }

            if (insights.businessInsights) {
                insightCards.push({
                    title: 'Business Intelligence',
                    icon: 'business',
                    iconClass: 'fas fa-lightbulb',
                    confidence: insights.businessInsights.confidence || 'medium',
                    insights: insights.businessInsights.insights || [],
                    extraInfo: insights.businessInsights.businessHealthScore
                        ? `Business Health: ${insights.businessInsights.businessHealthScore}/100`
                        : null
                });
            }

            if (insightCards.length === 0) {
                loadFallbackInsights('offline');
                return;
            }

            displayInsights(insightCards);
        }

        // Display personalized fallback insights
        function displayPersonalizedFallbackInsights(fallbackData) {
            const insightCards = [];

            if (fallbackData.salesPrediction) {
                insightCards.push({
                    title: 'Sales Intelligence',
                    icon: 'sales',
                    iconClass: 'fas fa-chart-line',
                    confidence: fallbackData.salesPrediction.confidenceLevel || 'medium',
                    insights: fallbackData.salesPrediction.insights || [],
                    extraInfo: fallbackData.salesPrediction.nextMonthRevenue 
                        ? `Projected Revenue: ${aiData?.businessProfile?.business?.currency || 'NPR'} ${fallbackData.salesPrediction.nextMonthRevenue.toFixed(0)}`
                        : null
                });
            }

            if (fallbackData.inventoryOptimization) {
                insightCards.push({
                    title: 'Inventory Optimization',
                    icon: 'inventory',
                    iconClass: 'fas fa-boxes',
                    confidence: fallbackData.inventoryOptimization.confidence || 'medium',
                    insights: fallbackData.inventoryOptimization.insights || []
                });
            }

            if (fallbackData.customerBehavior) {
                insightCards.push({
                    title: 'Customer Analytics',
                    icon: 'customers',
                    iconClass: 'fas fa-users',
                    confidence: fallbackData.customerBehavior.confidence || 'medium',
                    insights: fallbackData.customerBehavior.insights || []
                });
            }

            if (fallbackData.pricingStrategy) {
                insightCards.push({
                    title: 'Pricing Strategy',
                    icon: 'finance',
                    iconClass: 'fas fa-tag',
                    confidence: fallbackData.pricingStrategy.confidence || 'medium',
                    insights: fallbackData.pricingStrategy.insights || []
                });
            }

            if (fallbackData.productPerformance) {
                insightCards.push({
                    title: 'Product Performance',
                    icon: 'products',
                    iconClass: 'fas fa-shopping-bag',
                    confidence: fallbackData.productPerformance.confidence || 'medium',
                    insights: fallbackData.productPerformance.insights || []
                });
            }

            if (fallbackData.businessInsights) {
                insightCards.push({
                    title: 'Business Intelligence',
                    icon: 'business',
                    iconClass: 'fas fa-lightbulb',
                    confidence: fallbackData.businessInsights.confidence || 'medium',
                    insights: fallbackData.businessInsights.insights || []
                });
            }

            if (insightCards.length > 0) {
                displayInsights(insightCards);
            } else {
                loadFallbackInsights('fallback');
            }
        }

        // Load fallback insights when AI is unavailable (simplified)
        function loadFallbackInsights(mode = 'fallback') {
            console.log('Loading enhanced business insights...');
            
            try {
                // If rule-based recommendations are already loaded, don't override
                const existingCards = document.querySelectorAll('.insight-card');
                if (existingCards.length > 0) {
                    console.log('Rule-based recommendations already displayed');
                    return;
                }
                
                // Load simple fallback only if rule-based failed
                const insightCards = Object.values(fallbackInsights);
                
                if (!insightCards || insightCards.length === 0) {
                    console.error('No insight cards available!');
                    forceLoadBasicContent();
                    return;
                }
                
                displayInsights(insightCards);
                console.log('Fallback insights loaded successfully');
                
            } catch (error) {
                console.error('Error in loadFallbackInsights:', error);
                forceLoadBasicContent();
            } finally {
                hideSimpleLoading();
            }
        }

        // Force load basic content when everything else fails
        function forceLoadBasicContent() {
            const insightsSection = document.getElementById('insightsSection');
            if (insightsSection) {
                insightsSection.innerHTML = `
                    <div class="insight-card">
                        <div class="card-header">
                            <div class="card-icon sales">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="card-title">AI Insights Loading...</h3>
                        </div>
                        <p>Your personalized business insights will appear here once the system is fully loaded.</p>
                    </div>
                `;
            }
        }

        // Show simple loading animation (replacing skeleton)
        function showSimpleLoading() {
            const insightsSection = document.getElementById('insightsSection');
            if (!insightsSection) return;

            const loadingHTML = Array.from({length: 4}, (_, index) => `
                <div class="simple-loading-card">
                    <div class="loading-pulse"></div>
                    <div class="loading-text">Loading insights...</div>
                </div>
            `).join('');

            insightsSection.innerHTML = loadingHTML;
        }
        
        // Hide simple loading animation
        function hideSimpleLoading() {
            const insightsSection = document.getElementById('insightsSection');
            if (!insightsSection) return;
            
            // Clear loading content if it exists
            if (insightsSection.querySelector('.simple-loading-card')) {
                insightsSection.innerHTML = '';
            }
        }

        // Display AI insights from backend
        function displayAIInsights() {
            if (!aiData || !aiData.aiInsights) {
                loadFallbackInsights();
                return;
            }

            const insights = aiData.aiInsights.insights;
            const insightCards = [];

            // Convert AI data to display format
            if (insights.salesPrediction) {
                insightCards.push({
                    title: 'Sales Intelligence',
                    icon: 'sales',
                    iconClass: 'fas fa-chart-line',
                    confidence: insights.salesPrediction.confidence || 'medium',
                    insights: insights.salesPrediction.insights || insights.salesPrediction.predictions || fallbackInsights.sales.insights
                });
            }

            if (insights.inventoryOptimization) {
                insightCards.push({
                    title: 'Inventory Optimization',
                    icon: 'inventory',
                    iconClass: 'fas fa-boxes',
                    confidence: insights.inventoryOptimization.confidence || 'medium',
                    insights: insights.inventoryOptimization.optimizations || insights.inventoryOptimization.insights || fallbackInsights.inventory.insights
                });
            }

            if (insights.customerBehavior) {
                insightCards.push({
                    title: 'Customer Analytics',
                    icon: 'customers',
                    iconClass: 'fas fa-users',
                    confidence: insights.customerBehavior.confidence || 'medium',
                    insights: insights.customerBehavior.insights || insights.customerBehavior.behaviorPatterns || fallbackInsights.customers.insights
                });
            }

            if (insights.pricingStrategy) {
                insightCards.push({
                    title: 'Pricing Strategy',
                    icon: 'finance',
                    iconClass: 'fas fa-tag',
                    confidence: insights.pricingStrategy.confidence || 'medium',
                    insights: insights.pricingStrategy.strategies || insights.pricingStrategy.recommendations || fallbackInsights.finance.insights
                });
            }

            // Use fallback if no AI insights available
            if (insightCards.length === 0) {
                loadFallbackInsights('fallback');
                return;
            }

            displayInsights(insightCards);
        }

        // Display insights in cards with enhanced styling for rule-based recommendations
        function displayInsights(insightCards) {
            const insightsSection = document.getElementById('insightsSection');
            
            if (!insightsSection) {
                console.error('insightsSection element not found!');
                return;
            }
            
            const html = insightCards.map(card => `
                <div class="insight-card" ${card.customColor ? `style="border-left: 4px solid ${card.customColor};"` : ''}>
                    <div class="card-header">
                        <div class="card-icon ${card.icon}" ${card.customColor ? `style="background: ${card.customColor};"` : ''}>
                            <i class="${card.iconClass}"></i>
                        </div>
                        <h3 class="card-title">${card.title}</h3>
                    </div>
                    ${card.extraInfo ? `<div class="extra-info" ${card.customColor ? `style="background: ${card.customColor}20; color: ${card.customColor}; border: 1px solid ${card.customColor}40;"` : ''}><i class="fas fa-info-circle"></i> ${card.extraInfo}</div>` : ''}
                    <ul class="insights-list">
                        ${(card.insights || []).slice(0, 4).map(insight => `
                            <li>
                                <i class="fas fa-check-circle" ${card.customColor ? `style="color: ${card.customColor};"` : ''}></i>
                                <span>${escapeHtml(insight)}</span>
                            </li>
                        `).join('')}
                    </ul>
                    ${card.confidence ? `
                        <div class="confidence-indicator" style="margin-top: 10px; font-size: 0.8rem; color: #6c757d;">
                            <i class="fas fa-database"></i> Real data analysis
                        </div>
                    ` : ''}
                </div>
            `).join('');

            insightsSection.innerHTML = html;

            // Animate cards with stagger effect
            const cards = insightsSection.querySelectorAll('.insight-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 150);
            });
        }

        // Get authentication token
        function getAuthToken() {
            return localStorage.getItem('token') || '';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show toast notifications
        function showToast(message, type = 'info') {
            // Toast notifications disabled
            console.log('Toast notification suppressed:', message, type);
        }

        // Logout function
        function logout() {
            if (window.authService) {
                window.authService.logout();
            } else {
                localStorage.removeItem('token');
                window.location.href = '../landing.html';
            }
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            /* Animations removed */
        `;
        document.head.appendChild(style);

        // Backup initialization - simplified for real data mode
        function initializeNow() {
            console.log('Quick initialization with real data recommendations');
            updateAIHelperInterface();
            loadRealDataRecommendations();
        }

        // Initialize immediately if DOM is ready, otherwise wait for DOMContentLoaded
        if (document.readyState === 'loading') {
            // DOM not ready yet, wait for it
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Smart POS AI Dashboard - Initializing...');
                
                // Initialize navbar
                try {
                    if (typeof initSmartPOSNavbar === 'function') {
                        initSmartPOSNavbar({
                            title: 'Smart POS Assistant',
                            showBackButton: false,
                            showNotifications: true,
                            showProfile: true
                        });
                    }
                } catch (error) {
                    console.log('Navbar initialization skipped');
                }
                
                // Initialize menu
                try {
                    if (typeof window.SmartPOSMenu !== 'undefined') {
                        new window.SmartPOSMenu();
                    }
                } catch (error) {
                    console.log('Menu initialization skipped');
                }
                
                // Initialize the enhanced AI dashboard with real data engine
                console.log('Starting Smart POS AI Dashboard with real business data...');
                initializeAIDashboard();
            });
        } else {
            // DOM is already ready, initialize immediately
            console.log('DOM already ready, initializing Smart POS Assistant with real data immediately');
            
            // Update AI helper interface first
            updateAIHelperInterface();
            
            // Then load real data recommendations
            loadRealDataRecommendations();
        }
    </script>
</body>
</html>