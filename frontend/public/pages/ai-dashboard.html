<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart POS - AI Business Insights</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/menu.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Include Auth Service for token management -->
    <script src="../js/auth-service.js"></script>
    <script src="../js/api-service.js"></script>
    <script src="../js/menu.js"></script>
    <script src="../js/navbar.js"></script>
    
    <!-- Check authentication on page load -->
    <script>
        // Simple auth check for live server testing
        document.addEventListener('DOMContentLoaded', function() {
            // For live server testing, create a demo token if none exists
            if (!localStorage.getItem('token') && !sessionStorage.getItem('devMode')) {
                sessionStorage.setItem('devMode', 'demo-mode');
                console.log('Demo mode activated for live server testing');
            }
        });
    </script>

    <style>
        .main-content {
            padding: 20px;
            background-color: #f8f9fa;
            min-height: 100vh;
            margin-left: 250px;
            padding-top: 80px;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 80px 15px 15px 15px;
            }
        }

        .ai-container {
            max-width: 100%;
            margin: 0;
            padding: 0 10px;
        }

        .header-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-subtitle {
            font-size: 1.1rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        .business-context {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .business-info .business-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-right: 12px;
        }

        .business-info .business-type {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .data-quality {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .data-quality.excellent { color: #4CAF50; }
        .data-quality.good { color: #FFC107; }
        .data-quality.fair { color: #FF9800; }
        .data-quality.poor { color: #F44336; }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .insight-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .card-icon.sales { background: linear-gradient(135deg, #28a745, #20c997); }
        .card-icon.inventory { background: linear-gradient(135deg, #007bff, #6610f2); }
        .card-icon.customers { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .card-icon.finance { background: linear-gradient(135deg, #17a2b8, #6f42c1); }
        .card-icon.products { background: linear-gradient(135deg, #e83e8c, #fd7e14); }
        .card-icon.business { background: linear-gradient(135deg, #6f42c1, #e83e8c); }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .extra-info {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .extra-info i {
            font-size: 0.8rem;
        }

        /* Skeleton Animation Styles */
        .skeleton-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .skeleton-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: skeleton-loading 1.5s infinite;
        }

        .skeleton-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .skeleton-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #e9ecef, #f8f9fa);
            animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
        }

        .skeleton-title {
            width: 120px;
            height: 20px;
            background: linear-gradient(135deg, #e9ecef, #f8f9fa);
            border-radius: 4px;
            animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
        }

        .skeleton-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 60px;
            height: 20px;
            background: linear-gradient(135deg, #e9ecef, #f8f9fa);
            border-radius: 12px;
            animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
        }

        .skeleton-line {
            height: 14px;
            background: linear-gradient(135deg, #e9ecef, #f8f9fa);
            border-radius: 4px;
            margin-bottom: 12px;
            animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
        }

        .skeleton-line.short { width: 70%; }
        .skeleton-line.medium { width: 85%; }
        .skeleton-line.long { width: 95%; }

        @keyframes skeleton-loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes skeleton-pulse {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .confidence-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .confidence-badge.high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-badge.low {
            background: #f8d7da;
            color: #721c24;
        }

        .insights-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .insights-list li {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .insights-list li:last-child {
            border-bottom: none;
        }

        .insights-list li i {
            color: #28a745;
            margin-top: 2px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 80px 10px 15px 10px;
            }
            
            .ai-container {
                padding: 0 5px;
            }
            
            .header-title {
                font-size: 1.6rem;
                text-align: center;
            }
            
            .header-subtitle {
                font-size: 1rem;
                text-align: center;
                margin-bottom: 20px;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .insight-card {
                padding: 16px;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .card-icon {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            
            .confidence-badge {
                padding: 3px 8px;
                font-size: 0.7rem;
                top: 12px;
                right: 12px;
            }
            
            .insights-list li {
                padding: 10px 0;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 70px 8px 10px 8px;
            }
            
            .header-title {
                font-size: 1.4rem;
            }
            
            .header-subtitle {
                font-size: 0.95rem;
            }
            
            .insight-card {
                padding: 14px;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .insights-list li {
                font-size: 0.85rem;
                padding: 8px 0;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="ai-container">
            <div class="header-section">
                <h1 class="header-title">
                    <i class="fas fa-brain"></i>
                    <span id="personalizedTitle">AI Business Insights</span>
                </h1>
                <p class="header-subtitle">Smart recommendations powered by AI to help grow your business and increase profits</p>
                <div class="business-context" id="businessContext" style="display: none;">
                    <div class="business-info">
                        <span class="business-name" id="businessName"></span>
                        <span class="business-type" id="businessType"></span>
                    </div>
                    <div class="data-quality" id="dataQuality"></div>
                </div>
            </div>

            <div id="insightsSection" class="insights-grid">
                <!-- AI Insights will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // AI Dashboard for Smart POS System
        let aiData = null;
        let isLoading = false;

        // Smart fallback insights for when AI is not available
        const fallbackInsights = {
            sales: {
                title: 'Sales Optimization',
                icon: 'sales',
                iconClass: 'fas fa-chart-line',
                confidence: 'high',
                insights: [
                    "Your peak sales hours are 2-5 PM. Consider promotional offers during slower periods",
                    "Weekend sales are 40% higher. Plan inventory restocking accordingly",
                    "Cross-selling complementary items can increase average transaction value by 25%",
                    "Customer loyalty programs can boost repeat purchases by up to 35%"
                ]
            },
            inventory: {
                title: 'Inventory Intelligence',
                icon: 'inventory',
                iconClass: 'fas fa-boxes',
                confidence: 'high',
                insights: [
                    "Monitor fast-moving items weekly to prevent stockouts",
                    "Products sitting for over 30 days may need promotional pricing",
                    "Seasonal demand patterns suggest increasing inventory 2 weeks before festivals",
                    "ABC analysis shows 20% of products generate 80% of revenue"
                ]
            },
            customers: {
                title: 'Customer Behavior Analysis',
                icon: 'customers',
                iconClass: 'fas fa-users',
                confidence: 'medium',
                insights: [
                    "Regular customers make purchases every 7-10 days on average",
                    "New customer retention rate improves with follow-up contact within 48 hours",
                    "Customers prefer bundle deals over individual item discounts",
                    "Personal recommendations increase purchase probability by 60%"
                ]
            },
            finance: {
                title: 'Financial Health',
                icon: 'finance',
                iconClass: 'fas fa-piggy-bank',
                confidence: 'medium',
                insights: [
                    "Maintain 3-month inventory buffer for steady cash flow",
                    "Track daily expenses to identify cost-saving opportunities",
                    "Profit margins are healthiest on locally-sourced products",
                    "Digital payment adoption can reduce transaction costs by 15%"
                ]
            }
        };

        // Initialize the AI dashboard
        async function initializeAIDashboard() {
            console.log('AI Dashboard initializing...');
            
            try {
                // Try to load real AI insights
                await loadAIInsights();
            } catch (error) {
                console.error('AI service unavailable, using fallback insights:', error);
                loadFallbackInsights();
            }
        }

        // Attempt to load AI insights from backend with personalized data
        async function loadAIInsights() {
            console.log('Loading AI insights with skeleton animation...');
            
            // Show skeleton loading first
            showSkeletonLoading();
            
            try {
                const response = await fetch('/api/ai-business-intelligence/dashboard', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Personalized AI data received:', data);
                    
                    if (data.success && data.data) {
                        // Display personalized business context
                        displayBusinessContext(data.data);
                        
                        // Display AI insights
                        if (data.data.aiInsights && data.data.aiInsights.insights) {
                            aiData = data.data;
                            displayPersonalizedAIInsights();
                            showToast('Personalized AI insights loaded!', 'success');
                            return;
                        } else if (data.data.aiInsights) {
                            // Handle fallback recommendations
                            displayPersonalizedFallbackInsights(data.data.aiInsights);
                            showToast('Business insights loaded!', 'info');
                            return;
                        }
                    }
                }
                
                throw new Error('AI service not available');
                
            } catch (error) {
                console.log('Falling back to static insights:', error);
                // Small delay to show skeleton before loading fallback
                setTimeout(() => {
                    loadFallbackInsights();
                }, 800);
            }
        }

        // Display personalized business context
        function displayBusinessContext(data) {
            const businessContext = document.getElementById('businessContext');
            const businessName = document.getElementById('businessName');
            const businessType = document.getElementById('businessType');
            const dataQuality = document.getElementById('dataQuality');
            const personalizedTitle = document.getElementById('personalizedTitle');

            if (data.businessProfile) {
                const profile = data.businessProfile;
                
                // Update title with business name
                if (personalizedTitle && profile.business.name) {
                    personalizedTitle.textContent = `AI Insights for ${profile.business.name}`;
                }

                // Display business info
                if (businessName) {
                    businessName.textContent = profile.business.name || 'Your Business';
                }
                
                if (businessType) {
                    businessType.textContent = profile.business.type || 'Retail';
                }

                // Display data quality
                if (dataQuality && data.dataQuality) {
                    const quality = data.dataQuality;
                    dataQuality.innerHTML = `
                        <i class="fas fa-chart-bar"></i>
                        <span>Data Quality: ${quality.level.charAt(0).toUpperCase() + quality.level.slice(1)} (${Math.round(quality.score * 100)}%)</span>
                    `;
                    dataQuality.className = `data-quality ${quality.level}`;
                }

                // Show business context
                if (businessContext) {
                    businessContext.style.display = 'flex';
                }
            }
        }

        // Display personalized AI insights
        function displayPersonalizedAIInsights() {
            if (!aiData || !aiData.aiInsights || !aiData.aiInsights.insights) {
                loadFallbackInsights();
                return;
            }

            const insights = aiData.aiInsights.insights;
            const insightCards = [];

            // Convert personalized AI data to display format
            if (insights.salesPrediction) {
                insightCards.push({
                    title: 'Sales Intelligence',
                    icon: 'sales',
                    iconClass: 'fas fa-chart-line',
                    confidence: insights.salesPrediction.confidenceLevel || 'medium',
                    insights: insights.salesPrediction.insights || [],
                    extraInfo: insights.salesPrediction.nextMonthRevenue 
                        ? `Projected Revenue: ${aiData.businessProfile?.business?.currency || 'NPR'} ${insights.salesPrediction.nextMonthRevenue.toFixed(0)}`
                        : null
                });
            }

            if (insights.inventoryOptimization) {
                insightCards.push({
                    title: 'Inventory Optimization',
                    icon: 'inventory',
                    iconClass: 'fas fa-boxes',
                    confidence: insights.inventoryOptimization.confidence || 'medium',
                    insights: insights.inventoryOptimization.insights || [],
                    extraInfo: insights.inventoryOptimization.costSavings
                        ? `Potential Savings: ${aiData.businessProfile?.business?.currency || 'NPR'} ${insights.inventoryOptimization.costSavings.toFixed(0)}`
                        : null
                });
            }

            if (insights.customerBehavior) {
                insightCards.push({
                    title: 'Customer Analytics',
                    icon: 'customers',
                    iconClass: 'fas fa-users',
                    confidence: insights.customerBehavior.confidence || 'medium',
                    insights: insights.customerBehavior.insights || []
                });
            }

            if (insights.pricingStrategy) {
                insightCards.push({
                    title: 'Pricing Strategy',
                    icon: 'finance',
                    iconClass: 'fas fa-tag',
                    confidence: insights.pricingStrategy.confidence || 'medium',
                    insights: insights.pricingStrategy.insights || [],
                    extraInfo: insights.pricingStrategy.revenueImpact?.projectedIncrease
                        ? `Revenue Impact: +${aiData.businessProfile?.business?.currency || 'NPR'} ${insights.pricingStrategy.revenueImpact.projectedIncrease.toFixed(0)}`
                        : null
                });
            }

            if (insights.productPerformance) {
                insightCards.push({
                    title: 'Product Performance',
                    icon: 'products',
                    iconClass: 'fas fa-shopping-bag',
                    confidence: insights.productPerformance.confidence || 'medium',
                    insights: insights.productPerformance.insights || []
                });
            }

            if (insights.businessInsights) {
                insightCards.push({
                    title: 'Business Intelligence',
                    icon: 'business',
                    iconClass: 'fas fa-lightbulb',
                    confidence: insights.businessInsights.confidence || 'medium',
                    insights: insights.businessInsights.insights || [],
                    extraInfo: insights.businessInsights.businessHealthScore
                        ? `Business Health: ${insights.businessInsights.businessHealthScore}/100`
                        : null
                });
            }

            if (insightCards.length === 0) {
                loadFallbackInsights();
                return;
            }

            displayInsights(insightCards);
        }

        // Display personalized fallback insights
        function displayPersonalizedFallbackInsights(fallbackData) {
            const insightCards = [];

            if (fallbackData.salesPrediction) {
                insightCards.push({
                    title: 'Sales Intelligence',
                    icon: 'sales',
                    iconClass: 'fas fa-chart-line',
                    confidence: fallbackData.salesPrediction.confidenceLevel || 'medium',
                    insights: fallbackData.salesPrediction.insights || [],
                    extraInfo: fallbackData.salesPrediction.nextMonthRevenue 
                        ? `Projected Revenue: ${aiData?.businessProfile?.business?.currency || 'NPR'} ${fallbackData.salesPrediction.nextMonthRevenue.toFixed(0)}`
                        : null
                });
            }

            if (fallbackData.inventoryOptimization) {
                insightCards.push({
                    title: 'Inventory Optimization',
                    icon: 'inventory',
                    iconClass: 'fas fa-boxes',
                    confidence: fallbackData.inventoryOptimization.confidence || 'medium',
                    insights: fallbackData.inventoryOptimization.insights || []
                });
            }

            if (fallbackData.customerBehavior) {
                insightCards.push({
                    title: 'Customer Analytics',
                    icon: 'customers',
                    iconClass: 'fas fa-users',
                    confidence: fallbackData.customerBehavior.confidence || 'medium',
                    insights: fallbackData.customerBehavior.insights || []
                });
            }

            if (fallbackData.pricingStrategy) {
                insightCards.push({
                    title: 'Pricing Strategy',
                    icon: 'finance',
                    iconClass: 'fas fa-tag',
                    confidence: fallbackData.pricingStrategy.confidence || 'medium',
                    insights: fallbackData.pricingStrategy.insights || []
                });
            }

            if (fallbackData.productPerformance) {
                insightCards.push({
                    title: 'Product Performance',
                    icon: 'products',
                    iconClass: 'fas fa-shopping-bag',
                    confidence: fallbackData.productPerformance.confidence || 'medium',
                    insights: fallbackData.productPerformance.insights || []
                });
            }

            if (fallbackData.businessInsights) {
                insightCards.push({
                    title: 'Business Intelligence',
                    icon: 'business',
                    iconClass: 'fas fa-lightbulb',
                    confidence: fallbackData.businessInsights.confidence || 'medium',
                    insights: fallbackData.businessInsights.insights || []
                });
            }

            if (insightCards.length > 0) {
                displayInsights(insightCards);
            } else {
                loadFallbackInsights();
            }
        }

        // Load fallback insights when AI is unavailable
        function loadFallbackInsights() {
            console.log('Loading fallback insights with data:', fallbackInsights);
            try {
                const insightCards = Object.values(fallbackInsights);
                console.log('Insight cards to display:', insightCards);
                
                if (!insightCards || insightCards.length === 0) {
                    console.error('No insight cards available!');
                    forceLoadBasicContent();
                    return;
                }
                
                displayInsights(insightCards);
                console.log('Smart business insights loaded successfully');
            } catch (error) {
                console.error('Error in loadFallbackInsights:', error);
                forceLoadBasicContent();
            }
        }

        // Force load basic content when everything else fails
        function forceLoadBasicContent() {
            const insightsSection = document.getElementById('insightsSection');
            if (insightsSection) {
                insightsSection.innerHTML = `
                    <div class="insight-card">
                        <div class="card-header">
                            <div class="card-icon sales">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="card-title">AI Insights Loading...</h3>
                        </div>
                        <p>Your personalized business insights will appear here once the system is fully loaded.</p>
                    </div>
                `;
            }
        }

        // Show skeleton loading animation
        function showSkeletonLoading() {
            const insightsSection = document.getElementById('insightsSection');
            if (!insightsSection) return;

            const skeletonHTML = Array.from({length: 4}, (_, index) => `
                <div class="skeleton-card">
                    <div class="skeleton-badge"></div>
                    <div class="skeleton-header">
                        <div class="skeleton-icon"></div>
                        <div class="skeleton-title"></div>
                    </div>
                    <div class="skeleton-line long"></div>
                    <div class="skeleton-line medium"></div>
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line long"></div>
                </div>
            `).join('');

            insightsSection.innerHTML = skeletonHTML;
        }

        // Display AI insights from backend
        function displayAIInsights() {
            if (!aiData || !aiData.aiInsights) {
                loadFallbackInsights();
                return;
            }

            const insights = aiData.aiInsights.insights;
            const insightCards = [];

            // Convert AI data to display format
            if (insights.salesPrediction) {
                insightCards.push({
                    title: 'Sales Intelligence',
                    icon: 'sales',
                    iconClass: 'fas fa-chart-line',
                    confidence: insights.salesPrediction.confidence || 'medium',
                    insights: insights.salesPrediction.insights || insights.salesPrediction.predictions || fallbackInsights.sales.insights
                });
            }

            if (insights.inventoryOptimization) {
                insightCards.push({
                    title: 'Inventory Optimization',
                    icon: 'inventory',
                    iconClass: 'fas fa-boxes',
                    confidence: insights.inventoryOptimization.confidence || 'medium',
                    insights: insights.inventoryOptimization.optimizations || insights.inventoryOptimization.insights || fallbackInsights.inventory.insights
                });
            }

            if (insights.customerBehavior) {
                insightCards.push({
                    title: 'Customer Analytics',
                    icon: 'customers',
                    iconClass: 'fas fa-users',
                    confidence: insights.customerBehavior.confidence || 'medium',
                    insights: insights.customerBehavior.insights || insights.customerBehavior.behaviorPatterns || fallbackInsights.customers.insights
                });
            }

            if (insights.pricingStrategy) {
                insightCards.push({
                    title: 'Pricing Strategy',
                    icon: 'finance',
                    iconClass: 'fas fa-tag',
                    confidence: insights.pricingStrategy.confidence || 'medium',
                    insights: insights.pricingStrategy.strategies || insights.pricingStrategy.recommendations || fallbackInsights.finance.insights
                });
            }

            // Use fallback if no AI insights available
            if (insightCards.length === 0) {
                loadFallbackInsights();
                return;
            }

            displayInsights(insightCards);
        }

        // Display insights in cards with personalized enhancements
        function displayInsights(insightCards) {
            console.log('displayInsights called with:', insightCards);
            const insightsSection = document.getElementById('insightsSection');
            
            if (!insightsSection) {
                console.error('insightsSection element not found!');
                return;
            }
            
            const html = insightCards.map(card => `
                <div class="insight-card">
                    <div class="confidence-badge ${card.confidence || 'medium'}">${(card.confidence || 'medium').toUpperCase()}</div>
                    <div class="card-header">
                        <div class="card-icon ${card.icon}">
                            <i class="${card.iconClass}"></i>
                        </div>
                        <h3 class="card-title">${card.title}</h3>
                    </div>
                    ${card.extraInfo ? `<div class="extra-info"><i class="fas fa-info-circle"></i> ${card.extraInfo}</div>` : ''}
                    <ul class="insights-list">
                        ${(card.insights || []).slice(0, 4).map(insight => `
                            <li>
                                <i class="fas fa-check-circle"></i>
                                <span>${escapeHtml(insight)}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');

            console.log('Generated HTML:', html);
            insightsSection.innerHTML = html;

            // Animate cards
            const cards = insightsSection.querySelectorAll('.insight-card');
            console.log('Found cards for animation:', cards.length);
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.4s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        // Get authentication token
        function getAuthToken() {
            return localStorage.getItem('token') || 
                   sessionStorage.getItem('devMode') || 
                   'demo-token';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show toast notifications
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                info: '#007bff',
                warning: '#ffc107'
            };
            
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                color: #333;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                border-left: 4px solid ${colors[type] || colors.info};
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                font-size: 14px;
            `;
            
            // Mobile responsive adjustments
            if (window.innerWidth <= 768) {
                toast.style.cssText += `
                    top: 70px;
                    right: 10px;
                    left: 10px;
                    max-width: none;
                    font-size: 13px;
                    padding: 12px 16px;
                `;
            }
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Logout function
        function logout() {
            if (window.authService) {
                window.authService.logout();
            } else {
                localStorage.removeItem('token');
                sessionStorage.removeItem('devMode');
                window.location.href = '../landing.html';
            }
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);

        // Backup initialization - runs immediately if DOM is already ready
        function initializeNow() {
            console.log('Backup initialization triggered');
            if (!sessionStorage.getItem('devMode') && !localStorage.getItem('token')) {
                sessionStorage.setItem('devMode', 'demo-mode');
            }
            loadFallbackInsights();
        }

        // Initialize immediately if DOM is ready, otherwise wait for DOMContentLoaded
        if (document.readyState === 'loading') {
            // DOM not ready yet, wait for it
            document.addEventListener('DOMContentLoaded', function() {
                console.log('AI Dashboard page loaded, initializing...');
                
                // Set demo mode for live server testing
                if (!localStorage.getItem('token') && !sessionStorage.getItem('devMode')) {
                    sessionStorage.setItem('devMode', 'demo-mode');
                }
                
                // Initialize navbar with proper title
                try {
                    if (typeof initSmartPOSNavbar === 'function') {
                        initSmartPOSNavbar({
                            title: 'AI Business Insights',
                            showBackButton: false,
                            showNotifications: true,
                            showProfile: true
                        });
                        console.log('Navbar initialized');
                    } else {
                        console.log('initSmartPOSNavbar not available');
                    }
                } catch (error) {
                    console.log('Navbar initialization error:', error);
                }
                
                // Initialize menu
                try {
                    if (typeof window.SmartPOSMenu !== 'undefined') {
                        new window.SmartPOSMenu();
                        console.log('Menu initialized');
                    } else {
                        console.log('SmartPOSMenu not available');
                    }
                } catch (error) {
                    console.log('Menu initialization error:', error);
                }
                
                // Load fallback insights immediately - this should always work
                console.log('Loading fallback insights...');
                try {
                    loadFallbackInsights();
                    console.log('Fallback insights loaded successfully');
                } catch (error) {
                    console.error('Error loading fallback insights:', error);
                    // Force load with basic HTML if all else fails
                    forceLoadBasicContent();
                }
                
                // Then try to load personalized AI insights in background
                setTimeout(() => {
                    console.log('Attempting to load personalized AI insights...');
                    try {
                        loadAIInsights();
                    } catch (error) {
                        console.log('AI insights loading error:', error);
                    }
                }, 1500); // Increased delay to show fallback first
            });
        } else {
            // DOM is already ready, initialize immediately
            console.log('DOM already ready, initializing immediately');
            initializeNow();
        }
    </script>
</body>
</html>