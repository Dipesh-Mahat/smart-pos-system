<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>Smart POS - Receipt Detail</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/menu.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Include Auth Service for token management -->
    <script src="../js/security-logger.js"></script>
    <script src="../js/auth-service.js"></script>
    <script src="../js/api-service.js"></script>
    <script src="../js/demo-products.js"></script>

    <style>
        /* Header modifications */
        .back-button {
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Receipt styles */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #fff;
        }

        .receipt-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background-color: #e0e0e0;
            margin-bottom: 1px;
        }

        .item-details {
            display: flex;
            flex-direction: column;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .item-quantity {
            color: #666;
            font-size: 14px;
        }

        .item-amount {
            font-weight: bold;
        }

        .receipt-summary {
            margin-top: 20px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 16px;
        }

        .summary-row.total {
            font-weight: bold;
            font-size: 18px;
        }

        .summary-row.discount {
            color: #666;
        }

        .summary-row.grand-total {
            font-weight: bold;
            font-size: 20px;
            border-top: 1px solid #e0e0e0;
            margin-top: 8px;
            padding-top: 16px;
        }

        /* Skeleton Loading Animation */
        .loading-state {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }

        .skeleton-text {
            height: 16px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: pulse 1.5s infinite;
            border-radius: 4px;
            display: block;
            margin-bottom: 8px;
        }

        .skeleton-receipt {
            max-width: 300px;
            margin: 0 auto;
        }

        .skeleton-header {
            height: 24px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: pulse 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 20px;
            width: 80%;
        }

        .skeleton-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .skeleton-item-name {
            height: 14px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: pulse 1.5s infinite;
            border-radius: 4px;
            width: 60%;
        }

        .skeleton-item-price {
            height: 14px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: pulse 1.5s infinite;
            border-radius: 4px;
            width: 25%;
        }
        
        @keyframes pulse {
            0% { background-position: 0% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-button" onclick="window.location.href='transactions.html'">
                ‚Üê <span style="font-size: 18px;">Back</span>
            </div>
            <div class="app-title">Receipt 1</div>
            <div class="header-icons">
                <div class="notification-icon">üîî</div>
                <div class="profile-icon">üë§</div>
            </div>
        </div>

        <div class="main-content">
            <div class="receipt-title">Receipt 1</div>

            <div class="receipt-items">
                <div class="receipt-item">
                    <div class="item-details">
                        <div class="item-name">Item</div>
                        <div class="item-quantity">2 * 100</div>
                    </div>
                    <div class="item-amount">200</div>
                </div>

                <div class="receipt-item">
                    <div class="item-details">
                        <div class="item-name">Item 2</div>
                        <div class="item-quantity">3 * 100</div>
                    </div>
                    <div class="item-amount">300</div>
                </div>

                <div class="receipt-item">
                    <div class="item-details">
                        <div class="item-name">Item 3</div>
                        <div class="item-quantity">4 * 100</div>
                    </div>
                    <div class="item-amount">400</div>
                </div>
            </div>

            <div class="receipt-summary">
                <div class="summary-row total">
                    <div>TOTAL</div>
                    <div>900</div>
                </div>
                <div class="summary-row discount">
                    <div>DISCOUNT</div>
                    <div>10% OF 900</div>
                </div>
                <div class="summary-row grand-total">
                    <div>GRAND TOTAL</div>
                    <div>810</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-items">
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Dashboard</div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text"><a href="store-management.html">Store Management</a></div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Inventory</div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Transactions</div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Analytics & Report</div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Suppliers</div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Settings</div>
            </div>
            <div class="menu-item">
                <div class="menu-icon-folder">üìÅ</div>
                <div class="menu-text">Add Expense</div>
            </div>
        </div>
    </div>    <!-- Include JavaScript files -->
    <script src="../js/menu.js"></script>
    <script src="../js/navbar.js"></script>
    <script>
        // Get receipt ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const receiptId = urlParams.get('id');
        
        if (receiptId) {
            document.querySelector('.app-title').textContent = `Receipt ${receiptId}`;
            document.querySelector('.receipt-title').textContent = `Receipt ${receiptId}`;
        }
    </script>
    
    <script src="../js/menu.js"></script>
    <script src="../js/navbar.js"></script>
    <script>
        // Prevent auto-initialization
        window.navbarManualInit = true;

        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            if (!window.authService || !window.authService.isLoggedIn()) {
                window.location.href = '../landing.html';
                return;
            }
            
            // Load transaction details
            loadTransactionDetails();
            
            // Initialize navbar with custom actions for receipt detail page
            initSmartPOSNavbar('Receipt Details', [
                { icon: 'fas fa-print', label: 'Print', action: 'print-receipt' },
                { icon: 'fas fa-download', label: 'Download', action: 'download-receipt' },
                { icon: 'fas fa-share', label: 'Share', action: 'share-receipt' }
            ]);

            // Add event listeners for navbar actions
            document.addEventListener('navbarAction', function(event) {
                const action = event.detail.action;
                
                switch(action) {
                    case 'print-receipt':
                        printReceipt();
                        break;
                    case 'download-receipt':
                        downloadReceipt();
                        break;
                    case 'share-receipt':
                        shareReceipt();
                        break;
                }
            });
            
            // Handle back button
            document.querySelector('.back-button').addEventListener('click', function() {
                window.history.back();
            });
        });
        
        // Load transaction details from API
        function loadTransactionDetails() {
            // Get transaction ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const transactionId = urlParams.get('id');
            
            if (!transactionId) {
                showError('Transaction ID not provided');
                return;
            }
            
            const apiService = window.apiService;
            if (apiService) {
                // Show loading state with skeleton
                document.getElementById('receipt-contents').innerHTML = `
                    <div class="loading-state">
                        <div class="skeleton-receipt">
                            <div class="skeleton-header"></div>
                            <div class="skeleton-item">
                                <div class="skeleton-item-name"></div>
                                <div class="skeleton-item-price"></div>
                            </div>
                            <div class="skeleton-item">
                                <div class="skeleton-item-name"></div>
                                <div class="skeleton-item-price"></div>
                            </div>
                            <div class="skeleton-item">
                                <div class="skeleton-item-name"></div>
                                <div class="skeleton-item-price"></div>
                            </div>
                            <div class="skeleton-text" style="width: 70%; margin: 20px auto 10px;"></div>
                            <div class="skeleton-text" style="width: 50%; margin: 0 auto;"></div>
                        </div>
                    </div>
                `;
                
                // Fetch transaction from API
                apiService.request(`/transactions/${transactionId}`)
                    .then(response => {
                        if (response.success && response.data.transaction) {
                            renderReceiptDetails(response.data.transaction);
                        } else {
                            console.error('Failed to load transaction details:', response.message);
                            // Show demo receipt
                            renderDemoReceipt(transactionId);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading transaction details:', error);
                        // Show demo receipt
                        renderDemoReceipt(transactionId);
                    });
            } else {
                // Show demo receipt
                renderDemoReceipt(transactionId);
            }
        }
        
        // Render transaction details
        function renderReceiptDetails(transaction) {
            // Format transaction date
            const date = new Date(transaction.date);
            const formattedDate = date.toLocaleDateString();
            const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Update receipt header
            document.getElementById('receipt-shop').textContent = transaction.shopName || 'Smart POS Shop';
            document.getElementById('receipt-number').textContent = transaction._id.substring(0, 8);
            document.getElementById('receipt-date').textContent = `${formattedDate} ${formattedTime}`;
            
            // Update receipt items
            const itemsContainer = document.getElementById('receipt-items');
            itemsContainer.innerHTML = transaction.items.map(item => `
                <div class="receipt-item">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-quantity">${item.quantity} √ó ‚Çπ${item.price.toLocaleString()}</div>
                    </div>
                    <div class="item-total">‚Çπ${(item.quantity * item.price).toLocaleString()}</div>
                </div>
            `).join('');
            
            // Update receipt totals
            document.getElementById('receipt-subtotal').textContent = `‚Çπ${transaction.subtotal.toLocaleString()}`;
            document.getElementById('receipt-tax').textContent = `‚Çπ${(transaction.tax || 0).toLocaleString()}`;
            document.getElementById('receipt-discount').textContent = `‚Çπ${(transaction.discount || 0).toLocaleString()}`;
            document.getElementById('receipt-total').textContent = `‚Çπ${transaction.total.toLocaleString()}`;
            
            // Update payment details
            document.getElementById('receipt-payment-method').textContent = transaction.paymentMethod || 'Cash';
            
            // Update customer details if available
            if (transaction.customer) {
                document.getElementById('receipt-customer').textContent = transaction.customer;
            }
        }
        
        // Render demo receipt
        function renderDemoReceipt(transactionId) {
            // Get demo products for items
            const demoProducts = getDemoProducts().slice(0, 3);
            
            // Create demo transaction
            const demoTransaction = {
                _id: transactionId || 'TR10001',
                date: new Date().toISOString(),
                shopName: 'Smart POS Shop',
                items: demoProducts.map(product => ({
                    name: product.name,
                    quantity: Math.floor(Math.random() * 3) + 1,
                    price: product.price
                })),
                subtotal: 0,
                tax: 0,
                discount: 0,
                total: 0,
                paymentMethod: 'Cash',
                customer: 'Walk-in Customer'
            };
            
            // Calculate totals
            demoTransaction.subtotal = demoTransaction.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            demoTransaction.tax = Math.round(demoTransaction.subtotal * 0.05);
            demoTransaction.total = demoTransaction.subtotal + demoTransaction.tax;
            
            // Render the demo receipt
            renderReceiptDetails(demoTransaction);
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('receipt-contents').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>${message}</p>
                    <button onclick="window.history.back()" class="btn-primary">Go Back</button>
                </div>
            `;
        }
        
        // Print receipt
        function printReceipt() {
            window.print();
        }
        
        // Download receipt as PDF
        function downloadReceipt() {
            alert('Download receipt feature will be implemented');
        }
        
        // Share receipt
        function shareReceipt() {
            alert('Share receipt feature will be implemented');
        }
    </script>
</body>
</html>